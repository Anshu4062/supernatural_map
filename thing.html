<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="data:,">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <title>Google Maps API Example</title>
    <style>
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
        }
        
        #checkboxes {
            position: absolute;
            top: 120px;
            right: 5px;
            display: flex;
            flex-direction: column;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        #bigfoot-checkbox{
            margin-bottom: 5px;
        }

        #hauntedplaces-checkbox{
            margin-bottom: 5px;
        }

        #city-search {
            position: absolute;
            top: 65px;
            right: 5px;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        } 
        
    </style>
</head>
<body>
    <div id="city-search">
        <select id="state-select">
            <option value="">Select State</option>
            <option value="AL">Alabama</option>
            <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option>
            <option value="MI">Michigan</option>
        </select>
        <input type="text" id="city-input" placeholder="Enter City">
        <button id="search-button">Search</button>
        <button id="reset-button">Reset</button>
    </div>
    <div id="checkboxes">
        <label class="marker-checkbox">
            <input type="checkbox" id="bigfoot-checkbox" checked>Bigfoot
        </label>
        <label class="marker-checkbox">
            <input type="checkbox" id="hauntedplaces-checkbox" checked>Haunted Places
        </label>
        <label class="marker-checkbox">
            <input type="checkbox" id="ufosightings-checkbox" checked>UFO Sightings
        </label>
    </div>
    <div id="map"></div>
    <script>
        var map;
        var bounds;
        var markers = {
          bigfoot: [],
          hauntedplaces: [],
        };
        
        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 40.7128, lng: -74.0060 },
            streetViewControl: false,
            styles: [
              {
                featureType: 'poi',
                stylers: [{ visibility: 'off' }],
              },
              {
                featureType: 'transit',
                stylers: [{ visibility: 'off' }],
              },
            ],
          });
        
          bounds = new google.maps.LatLngBounds();
        
          loadMarkers('bigfoot', 'bigfoot_data.csv', 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', 4, 5, 8);
          loadMarkers('hauntedplaces', 'hauntedplaces_data.csv', 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', 6, 5, 4);
        
          var checkboxes = document.querySelectorAll('#checkboxes input[type="checkbox"]');

          checkboxes.forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
              var category = checkbox.id.split('-')[0];
              toggleMarkers(markers[category], this.checked);
            });
          });
        
          var searchButton = document.getElementById('search-button');
          var resetButton = document.getElementById('reset-button');
        
          resetButton.addEventListener('click', function () {
            showAllMarkers();
          });
        
          searchButton.addEventListener('click', function () {
            var stateSelect = document.getElementById('state-select');
            var selectedState = stateSelect.value;
            var cityInput = document.getElementById('city-input').value;
        
            if (cityInput.trim() !== '') {
              filterMarkersByCityAndState(cityInput, selectedState);
            } else if (selectedState.trim() !== '') {
              filterMarkersByState(selectedState);
            } else {
              showAllMarkers();
            }
          });
        }
        
        function loadMarkers(category, dataUrl, markerIconUrl, latIndex, lngIndex, stateIndex) {
          Papa.parse(dataUrl, {
            download: true,
            skipEmptyLines: true,
            skipLinesWithEmptyValues: true,
            complete: function (results) {
              results.data.forEach((row, index) => {
                if (index === 0) {
                  return;
                }
        
                var lat = parseFloat(row[latIndex]);
                var lng = parseFloat(row[lngIndex]);
                var state = row[stateIndex];
        
                var title = row[2];
                var markerIcon = {
                  url: markerIconUrl,
                  scaledSize: new google.maps.Size(32, 32),
                  origin: new google.maps.Point(0, 0),
                  anchor: new google.maps.Point(16, 32),
                };
        
                var marker = new google.maps.Marker({
                  position: { lat: lat, lng: lng },
                  map: map,
                  title: title,
                  icon: markerIcon,
                  category: category,
                  state: state,
                });
                markers[category].push(marker);
                bounds.extend(marker.getPosition());
              });
        
              map.fitBounds(bounds);
            },
          });
        }
        
        function toggleMarkers(categoryMarkers, visible) {
            categoryMarkers.forEach(function (marker) {
                marker.setVisible(visible);
            });
        }
        
        function showAllMarkers() {
          Object.values(markers).forEach(function (categoryMarkers) {
            categoryMarkers.forEach(function (marker) {
              marker.setMap(map);
            });
          });
        
          map.fitBounds(bounds);
        }
        
        function debugMarkers() {
            console.log(markers.bigfoot);
          }

        function filterMarkersByCityAndState(city, state) {
            var newBounds = new google.maps.LatLngBounds();
          
            Object.values(markers).forEach(function (categoryMarkers) {
              categoryMarkers.forEach(function (marker) {
                var markerState = marker.state.toLowerCase();
                var stateInitial = getStateInitial(state).toLowerCase();
                var stateName = getStateName(state).toLowerCase();
          
                if (
                  (city === '' || marker.title.toLowerCase().includes(city.toLowerCase())) &&
                  (state === '' ||
                    markerState === state.toLowerCase() ||
                    markerState === stateInitial ||
                    markerState === stateName)
                ) {
                  marker.setMap(map);
                  newBounds.extend(marker.getPosition());
                } else {
                  marker.setMap(null);
                }
              });
            });
          
            if (!newBounds.isEmpty()) {
              map.fitBounds(newBounds);
            }
          }

        function filterMarkersByState(state) {
          var newBounds = new google.maps.LatLngBounds();
        
          Object.values(markers).forEach(function (categoryMarkers) {
            categoryMarkers.forEach(function (marker) {
              if (marker.state.toLowerCase() === state.toLowerCase()) {
                marker.setMap(map);
                newBounds.extend(marker.getPosition());
              } else {
                marker.setMap(null);
              }
            });
          });
        
          if (!newBounds.isEmpty()) {
            map.fitBounds(newBounds);
          }
        }
        
        initMap();
        
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyTMQc1TspKrMM4fXT9B99ct4SLAIp4RQ&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>